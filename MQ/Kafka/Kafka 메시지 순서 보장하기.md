# Kafka 메시지 순서 보장하기
* **Producer, Consumer, Partitioner, Broker**의 설정값에 따라 동작 방식이 달라진다.

### Producer
#### 동기/비동기 API
* 동기/비동기 방식으로 메시지 전송하기
* 동기 방식은 비동기 방식에 비해 **메시지 전송이 정상적으로 완료될 때까지 다음 메시지를 전송하지 않기 떄문**에 순서 보장하여 메시지를 전송할 수 있다.
* 동기 방식은 메시지가 정상적으로 전송될 때까지 블로킹하기 때문에 성능은 떨어진다.

#### ack mode
* 메시지가 브로커에 도착하면 Leader 파티션에 적재한 뒤, Follower 파티션에 적재한다.
1. acks=0 의 경우
    * 브로커에 메시지가 정상적으로 도착했는지 여부를 확인하지 않는다. 즉 **메시지 유실 가능성이 높다.**
2. acks=1 의 경우
    * Leader 파티션에 정상적으로 적재가 완료된 것만 보장한다.
    * Follower 파티션에 복제가 완료되기 전에 **Leader 파티션의 브로커에 장애가 발생하면 메시지가 유실될 수 있다.**
3. acks=-1 (all) 의 경우
    * `min.insync.replicas` 설정값의 수만큼 파티션에 쓰기를 보장한다.
    * `min.insync.replicas` 설정값을 2 이상으로 설정했을 경우 Leader 파티션의 브로커에 장애가 발생하더라도 다른 Follower 파티션에 메시지 동기화가 완료된 상태이기에 **메시지가 유실될 가능성이 가장 낮다.**
* **성능**: `-1 <= 1 < 0`
* **안정성**: `0 < 1 < -1`

#### max.in.flight.per.connection
* 메시지를 전송할 때 전송에 대한 응답을 받기 전에 다음 메시지를 전송할 수 있다.
* 메시지 전송 성능을 향상시키기 위한 설정
* 전송 실패할 경우 메시지 순서가 역전될 수 있다.

#### partitioner
* Default Partitioner를 사용하는 경우 메시지의 키 값이 있는 경우 메시지 key의 해시값을 기준으로 파티션이 할당된다.
* 이로 인해 같은 key 값을 가진 메시지는 같은 파티션으로 할당된다.
* 메시지의 처리 순서가 중요한 경우 메시지의 key값을 잘 설정할 것
* Default Partitioner를 사용하더라도 토픽의 파티션 수를 늘리는 경우 순서가 보장되지 않을 수 있어 주의해야 한다.
  * 파티션 수를 늘리면 특정 키의 메시지가 다른 파티션에 적재될 수 있기 때문이다.
  * **카프카는 같은 파티션의 메시지만 순서 보장한다.**
