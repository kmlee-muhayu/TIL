# AWS SQS (Simple Queue Service)
### SQS (Simple Queue Service) 란?
* 서버들끼리 사용할 수 있는 메시지 큐를 제공하는 서비스
* 해야할 일을 나중에 처리하거나, 다른 시스템이 처리할 수 있도록 하기 위한 비동기 메시징 서비스
* 시스템이 처리해야 할 TO-DO list
* 애플리케이션 간 비동기 처리에 도움
  
요약하자면, 사용자에게 결과를 빨리 보여줘야 하는 작업과 시간이 오래 걸리는 작업을 분리할 때 중요한 작업과 그렇지 않은 작업을 분리할 때 SQS 큐를 사용할 수 있다.  

### 기본 개념
<img src="https://velog.velcdn.com/images/holicme7/post/0598c8c0-b17e-4bd5-a1e2-5b59634517b4/image.png" width="800"/>

#### 메시지
* SQS의 기본 단위
* 메시지는 **XML, JSON**과 같은 텍스트 형태이며 최대 **64KB** 까지 보낼 수 있다.
* 유니코드 문자를 사용할 수 있다.
* 보관 기간을 초 단위로 설정할 수 있다.
  * 기본 보관 시간은 **345,600초 (4일)** 이며 **60초 (1분) 부터 1,209,600 (14일) 까지** 설정할 수 있다.
  * 메시지 보관 기간이 지나면 자동으로 삭제된다.
* 메시지마다 **고유한 ID**가 부여된다.
* **3~4KB짜리 메시지라도 64KB로 책정된다.**
  * 용량이 작은 메시지를 자주 처리하는 것보다 메시지를 모아서 배치 API로 처리하는 게 요금을 아낄 수 있는 방법
#### 큐 (Queue)
* 메시지를 담는 공간
* 리전 별로 생성해야 하며 HTTP 프로토콜을 이용하여 다른 리전끼리도 메시지를 주고 받을 수 있다.
  * 큐의 이름은 모든 리전에서 유일해야 한다.
* 담을 수 있는 메시지의 개수는 무제한
* **연속 30일동안 아무 요청이 발생하지 않으면 AWS가 큐를 삭제할 수 있으므로,** 설계 단계에서 이 부분을 고려해야 한다.
* 자료 구조의 큐와 이름이 같지만, **선입선출(FIFO)를 보장하지 않는다.**
* 다양한 접근 권한과 정책을 설정할 수 있으며, AWS 계정 번호를 이용하여 **다른 AWS 계정과도 큐를 공유할 수 있다.**
* 같은 리전 안에서의 데이터 전송은 무료
  * 다른 리전에 있는 큐나 EC2 인스턴스와 메시지를 주고 받으면 데이터 요금이 부과된다.
* 큐 생성 개수는 무제한
#### 배치 API
* API 한 번에 메시지를 최대 10개 혹은 최대 256KB 까지 동시에 처리할 수 있다.
* 여러 메시지를 합쳐서 64KB 이하일 때 배치 API를 이용하면 요청 1개로 청구된다.
#### 보기 제한 시간 (Visibility Timeout)
* 메시지를 받은 뒤 특정 시간 동안 **다른 곳에서 동일한 메시지를 다시 꺼내볼 수 없게** 하는 기능
* **0초부터 12시간 까지** 설정 가능
* 큐 하나에 여러 서버가 메시지를 받을 때 동일한 메시지를 동시에 처리하는 것을 방지한다.
* Message Available (Visible)
  * 내용을 꺼내서 볼 수 있는 상태인 메시지 개수
* Messages in Flight (Not Visible)
  * 다른 곳에서 메시지를 보고 있어서 현재는 내용을 볼 수 없는 상태인 메시지 개수
  * 최대 120,000개 까지이며 최대치를 넘어서면 에러 (OverLimit) 발생
#### 지연 전송 (Delay Delivery)
* 특정 시간 동안 메시지를 **받지 못하게** 하는 기능
* 지연되는 시간 동안에는 Messages in Flight (Not Visible) 에 포함
#### 처리 실패 큐 (Dead Letter Queues)
* 보통 메시지를 받고 작업이 처리되면  메시지를 삭제한다. 하지만 설정한 횟수를 초과하여 메시지를 받았는데 삭제되지 않고 남아있다면 처리 실패 큐로 보냄
* 메시지를 받는 횟수는 1번부터 1000번 까지 설정할 수 있다.
* 일반 큐 하나에 여러 개의 처리 실패 큐를 연결할 수 있다.
* 처리 실패 큐는 일반 큐와 같은 리전에 생성해야 한다.
#### 짧은 폴링 (Short Polling)
* 메시지 받기 요청을 하면 결과를 바로 받는다.
* 메시지가 있으면 메시지를 가져오고 없으면 그냥 나온다.
* 설정
  * ReceiveMessage 요청에서 WaitTimeSeconds를 0으로 설정했을 때
  * 큐 설정의 ReceiveMessageWaitTimeSeconds를 0으로 설정했을 때
#### 긴 폴링 (Long Polling)
* 메시지가 있으면 바로 가져오고, 메시지가 없으면 메시지가 올 때까지 기다린다.
* 메시지가 계속 오지 않으면 긴 폴링 제한 시간까지 기다린다.
* 기본 제한시간은 20초이며 1초부터 최대 20초까지 설정할 수 있다.
  * ReceiveMessage 요청의 WaitTimeSeconds가 0보다 크면 큐 설정의 ReceiveMessageWaitTimeSeconds 값보다 우선순위가 높다.
#### 요금
* 64KB 당 요청 1개로 청구
* 256KB 짜리 배치 API를 한 번에 호출하면 요청 4개로 청구
### SQS 함수 종류
* `CreateQueue` : 큐 생성
* `ListQueue` : 큐 목록 출력
* `DeleteQueue` : 큐 삭제
* `SendMessage` : 큐에 메시지 추가
* `SendMessageBatch` : 큐에 여러 메시지 추가
* `ReceiveMessage` : 큐에서 메시지 꺼내서 보기
* `ChangeMessageVisibility` : 메시지의 보기 제한 시간 변경
* `ChangeMessageVisibilityBatch` : 여러 메시지의 보기 제한 시간 변경
* `DeleteMessage` : 큐에서 메시지 삭제
* `DeleteMessageBatch` : 큐에서 여러 메시지 삭제
* `SetQueueAttributes` : 큐 설정 변경 (지연 전송 시간, 최대 메시지 크기, 메시지 보관 기간, 접근 정책, 짧은/긴 폴링 시간, 처리 실패 큐)
* `GetQueueAttributes` : 큐 설정 확인 (메시지 개수, 큐 생성 시간, 최종 큐 변경 시간, 큐 ARN, 지연 전송 시간, 최대 메시지 크기, 메시지 보관 기간, 접근 정책, 짧은/긴 폴링 시간, 처리 실패 큐)
* `GetQueueUrl` : 큐 엔드포인트 URL 확인
* `AddPermission` : 다른 AWS 계정에 대한 접근 권한 설정
* `RemovePermission` : 다른 AWS 계정에 대한 접근 권한 삭제

